/*
 * main.c

 *
 *  Created on: Oct 17, 2023
 *      Author: AhmedAbogabl
 */
//#define F_CPU 16000000UL
#include <avr/delay.h>

#include "HAL/EEPROM/EEPROM_interface.h"
#include "MCAL/DIO/DIO_interface.h"
#include "MCAL/PORT/PORT.h"
#include "MCAL/SPI/includes/SPI_interface.h"
#include "MCAL/GI/GI_interface.h"
#include "MCAL/UART/includes/UART_interface.h"


#define ADMIN_PW 1234
#define EEPROM_ID_START 0x00
#define EEPROM_PW_START 0x01

static u8 USERS[20];

u8 ids_index=0;
u8 pws_index=0;


void ADD_user(){
u8 user[4];
UART_TransmitString("\r\n Enter user id (1-20):");

	user[0] =(u8)UART_Receive();

	UART_TransmitString("\r\n Enter user password(****):");
	user[1] =(u8)UART_Receive();
	user[2] = (u8)UART_Receive();
	user[3] = (u8)UART_Receive();

	USERS[user[0]] =ids_index;

	EEPROM_voidWritePage(0x00+ids_index*4,user,4);
	ids_index++;//decrement in delete
}


void EDIT_user(){
u8 user[4];
	UART_TransmitString("\r\n Enter user id (1-20):");
	user[0] =(u8)UART_Receive();
	UART_TransmitString("\r\n Enter NEW password(****):");
	user[1] =(u8)UART_Receive();
	user[2] = (u8)UART_Receive();
	user[3] = (u8)UART_Receive();
	EEPROM_voidWritePage(0x00+USERS[user[0]]*4,user,4);
}

void DELETE_user(){
	u8 user[4];
		UART_TransmitString("\r\n Enter user id (1-20):");
		user[0] =(u8)UART_Receive();
		USERS[user[0]] = NULL;

//		EEPROM_voidWritePage(0x00+USERS[user[0]]*4,user,4);
}


void Handle_user(u8 Users_Pick)
{
switch (Users_Pick) {
	case 1:
		ADD_user();
		break;
	case 2:
		DELETE_user();
		break;
	case 3:
		EDIT_user();
		break;
	default:
		break;
}
}



//////////////////////////////////////SPI
u8 RX_USER[4];
u8 INDEX=0;

void check_user(void)
{
	//ched user id in eeprom
if(USERS[RX_USER[0]] != NULL)
{

	Dio_WriteChannel(PA_5,STD_HIGH);
}	//check user pw in eeprom
}

void get_user(u8 copy_u8RxData){
	if(INDEX==0){
		RX_USER[0] = copy_u8RxData;//data
	INDEX++;
	}
	else if (INDEX ==1) {
		RX_USER[1]=copy_u8RxData;
	}
	else if (INDEX ==2) {
		RX_USER[2]=copy_u8RxData;
	}

	else if (INDEX == 3) {
		RX_USER[3] = copy_u8RxData;
		INDEX=0;
		check_user();
	}


}
int main(){
	u8 access=0;
	u8 trials =0;
	u16 admin=0;
    u8	Users_Pick=0;

    Port_Init(pin_cfg);
    UART_Init();
	SPI_voidInit();
	EEPROM_voidInit();
	Dio_WriteChannel(PA_5,STD_HIGH);
	GI_voidEnable();
	SPI_voidTransmitAsynchronous(2,get_user);
//	EEPROM_voidWriteByte(0x00,0);
//	EEPROM_voidWriteByte(0x01,1);
//	EEPROM_voidWriteByte(0x02,2);
//	EEPROM_voidWriteByte(0x03,3);
//EEPROM_voidWriteByte(0x00,5);
//u8 a=5 ,i=0;
	//while(1)
{
	while(1)
	{
	//UART_Send(i);
		UART_TransmitString("ENTER PASSWORD:");
		admin = UART_ReceiveNumber();
		if(admin == ADMIN_PW)
			{
			access =1;
			break;
			}

		else
		{
			access=0;
		}

		if(trials == 3)
		{
			access=0;
			break;
		}
		trials++;
	}

	if(access==1){
		//handle admin functionality
		UART_TransmitString("\r\n 1 FOR ADDING NEW USER:\r\n");
		UART_TransmitString(" 2 FOR DELETING A USER:\r\n");
		UART_TransmitString(" 3 FOR EDITING A USER \r\n");
		Users_Pick= UART_ReceiveNumber();

//		SPI_voidTransmitAsynchronous('T',get_user);
		Handle_user(Users_Pick);


	}

	else {
		UART_TransmitString("CLS\r\n");
		UART_TransmitString("\r\n OUT OF TRIALS :\r\n");
		UART_TransmitString("\r\n SYSTEM LOCKED :\r\n");
		exit(1);
	}

}
	return 0;
}










































/*
int main()
{

    u16 in_pass = 0; // ldr adc
    u8 key = 'T',i = 0, access = 0;

    // mcu pins configurations
    Port_Init(pin_cfg);
    EEPROM_voidInit();
    LCD_Init(); // on kpinput
    KP_Init();  // output unit

//while(1)
{
    LCD_PutString("I/P PASSWORD:");
    while (1)
    {
        // get password
        KP_GetKey(&key);
        if ((key != 'T') && (key >= '0') && (key <= '9'))
        {
            LCD_PutChar(key);

            if (in_pass == 0)
                in_pass = key - '0';
            else
                in_pass = in_pass * 10 + (key - '0');

            key = 'T';
        }
        // check password
        if (key == '#')
        {
            i++;
            if (in_pass == ADMIN_PW)
            {
                access = 1;
                break;
            }
            else
            {
                in_pass = 0;
                LCD_CLR();
                LCD_PutString("Left ");
                LCD_PutInt(3-i);
                LCD_PutString(" trial");
                _delay_ms(1000);
                LCD_CLR();
                LCD_PutString("I/P PASSWORD:");
                if (i == 3)break;
            }
        }
    }

if (access == 1)
{

//	SRVM_voidOn(180);

	for(i=5;i>0;i--){
	_delay_ms(1000);
	LCD_CLR();

	LCD_PutString("WELCOME IN");
	LCD_GoTo(2,1);
	LCD_PutString("Door closes in:");
	//LCD_GoTo(3,1);
	//LCD_PutString("in:");
	LCD_PutInt(i);
	}
	SRVM_voidOn(90);
_delay_ms(100);
	//SRVM_voidOff();
	LCD_CLR();
}

else
{
	LCD_CLR();
	LCD_PutString_at_X_Y("SYSTEM LOCKED", 1, 1);
	Dio_WriteChannel(LED, STD_HIGH);
	Dio_WriteChannel(BUZ, STD_HIGH);
	_delay_ms(1000);
	Dio_WriteChannel(BUZ, STD_LOW);
	//LCD_CLR();
}
//_delay_ms(5000);
//in_pass=0;
//i = 0;
//access = 0;
//LCD_CLR();
}

return 0;
}
*/
